{% extends "layout.twig" %}

{% block content %}
    {# ‚úÖ safe_back –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å: –ª–∏–±–æ back_url –∏–∑ —Ä–æ—É—Ç–∞, –ª–∏–±–æ fallback #}
    {% set safe_back = (back_url is defined and back_url) ? back_url : (visit.pet_id is defined ? ('/pets/' ~ visit.pet_id ~ '#visits') : '/visits/journal') %}

    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
            <div class="d-flex align-items-center gap-2">
                <span class="badge text-bg-light border">‚úèÔ∏è</span>
                <h1 class="h4 fw-bold m-0">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∏–∑–∏—Ç</h1>
            </div>
            <div class="muted small mt-1">
                {% if visit.client_full_name is defined and visit.client_full_name %}
                    üë§ {{ visit.client_full_name|e }}
                {% endif %}
                {% if visit.pet_name is defined and visit.pet_name %}
                    <span class="mx-2 muted">‚Ä¢</span>üêæ {{ visit.pet_name|e }}
                {% endif %}
            </div>
        </div>

        <a class="btn btn-outline-secondary" href="{{ safe_back|e }}">‚Üê –ù–∞–∑–∞–¥</a>
    </div>

    {% if errors is not empty %}
        <div class="alert alert-danger">
            <div class="fw-bold mb-1">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—è:</div>
            <ul class="mb-0">
                {% for err in errors %}
                    <li>{{ err|e }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <div class="card app-card app-shadow">
        <div class="card-body p-3">
            <form method="post" action="/visits/{{ visit.id }}/edit?back={{ safe_back|url_encode }}">
                <div class="row g-3">
                    <div class="col-12 col-md-3">
                        <label class="form-label">–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞</label>
                        <input class="form-control" name="visit_date" value="{{ data.visit_date|e }}"
                               placeholder="–î–î-–ú–ú-–ì–ì–ì–ì –∏–ª–∏ –ì–ì–ì–ì-–ú–ú-–î–î">
                        <div class="muted small mt-1">–ú–æ–∂–Ω–æ: 13-12-2025 –∏–ª–∏ 2025-12-13</div>
                    </div>

                    <div class="col-12 col-md-3">
                        <label class="form-label">–í—Ä–µ–º—è</label>
                        <input class="form-control" name="visit_time" value="{{ data.visit_time|e }}" placeholder="HH:MM">
                    </div>

                    <div class="col-12 col-md-6">
                        <label class="form-label">–ñ–∞–ª–æ–±–∞</label>
                        <input class="form-control" name="complaint" value="{{ data.complaint|e }}"
                               placeholder="–ö–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç">
                    </div>

                    <div class="col-12">
                        <label class="form-label">–î–∏–∞–≥–Ω–æ–∑</label>
                        <input class="form-control" name="diagnosis" value="{{ data.diagnosis|e }}">
                    </div>

                    <div class="col-12">
                        <label class="form-label">–ü—Ä–æ—Ü–µ–¥—É—Ä—ã</label>
                        <textarea class="form-control" name="procedures" rows="3">{{ data.procedures|e }}</textarea>
                    </div>

                    <div class="col-12">
                        <label class="form-label">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</label>
                        <textarea class="form-control" name="recommendations" rows="3">{{ data.recommendations|e }}</textarea>
                    </div>

                    <div class="col-12 d-flex gap-2">
                        <button class="btn btn-success btn-edit" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <a class="btn btn-outline-secondary" href="{{ safe_back|e }}">–û—Ç–º–µ–Ω–∞</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
{% endblock %}
